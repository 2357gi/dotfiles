#!/bin/bash
# tmux ide mode with layout selection via fzf

layout=$(printf '%s\n' \
  "default: 2pane split" \
  "dev: yazi + claude + lazygit" \
| fzf --prompt="layout> " --height=10 --reverse)

[ -z "$layout" ] && exit 0

case "$layout" in
  default*)
    tmux split-window -h -p 50
    tmux split-window -p 50
    tmux select-pane -R
    clear
    ;;
  dev*)
    dir=""
    if command -v git-wt &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
      # Build worktree list: existing worktrees + new branch option
      wt_list=$(git wt 2>/dev/null | tail -n +2)
      choices=$(printf '%s\n%s' "+ new branch" "$wt_list" | sed '/^$/d')
      selected=$(echo "$choices" | fzf --prompt="worktree> " --height=20 --reverse --header="Select worktree or create new branch")

      if [ -z "$selected" ]; then
        exit 0
      elif [ "$selected" = "+ new branch" ]; then
        # Read branch name from user
        printf "branch name: "
        read -r branch_name
        [ -z "$branch_name" ] && exit 0

        # Optionally select start-point from remote branches
        start_point=$(git branch -r --format='%(refname:short)' | fzf --prompt="start-point> " --height=20 --reverse --header="Select start-point (ESC to use HEAD)")
        if [ -n "$start_point" ]; then
          git wt "$branch_name" "$start_point"
        else
          git wt "$branch_name"
        fi
        dir=$(git wt "$branch_name" 2>/dev/null | tail -1)
      else
        wt_path=$(echo "$selected" | awk '{print $(NF-1)}')
        dir=$(git wt "$wt_path" 2>/dev/null | tail -1)
      fi
    fi
    dir="${dir:-$(pwd)}"
    [ ! -d "$dir" ] && dir="$(pwd)"

    tmux split-window -h -p 50 -c "$dir"
    tmux split-window -v -p 40 -c "$dir"
    tmux send-keys 'lazygit' Enter
    tmux select-pane -U
    tmux send-keys 'claude' Enter
    tmux select-pane -L
    tmux send-keys "cd '$dir' && yazi" Enter
    tmux select-pane -R
    tmux select-pane -U
    ;;
esac
