#  _______ __  __ __   __ __   __     _______ _______ __    _ _______
# |      |  |_|  |  | |  |  |_|  |   |       |       |  |  | |       |
# |_    _|       |  | |  |       |   |       |   _   |   |_| |    ___|
#  |   | |       |  |_|  |       |   |       |  | |  |       |   |___
#  |   | |       |       ||     | ___|      _|  |_|  |  _    |    ___|
#  |   | | ||_|| |       |   _   |   |     |_|       | | |   |   |
#  |___| |_|   |_|_______|__| |__|___|_______|_______|_|  |__|___|



# --------------------------------- General ---------------------------------

set-option -g default-shell /bin/zsh
set -g default-command /bin/zsh
set -s escape-time 0

unbind C-b
set -g prefix C-Space
bind Space send-prefix
# ---------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# common
# ------------------------------------------------------------------------------
set-window-option -g mode-keys  vi      # xterm キーを有効にする
set -g history-limit 20000          # ヒストリの上限
set -g base-index 0             # windowsの番号を0始まりにする
set -g pane-base-index 0            # paneの番号を0始まりにする

# ウィンドウを閉じた際に番号を詰める
set -g renumber-windows on
# bind-key -rで指定しているkeyはprefix-keyを再度押さなくとも連続で効く
set -g repeat-time 400
# display-message
set -g display-time 1500
# focus events
set -g focus-events on

# default shellの設定
set-option -g default-shell "${SHELL}"
set -g default-command "${SHELL}"

# mouseの有効か
set -g mouse on

# reroad
bind-key -T prefix r source-file ~/.tmux.conf \; display-message 'Reload'

# custom help (floating popup)
bind-key -T prefix ? display-popup -w 80% -h 80% -E "$HOME/dotfiles/bin/tmux-help | less -R"
bind-key -T prefix C-h display-popup -w 80% -h 80% -E "$HOME/dotfiles/bin/tmux-help | less -R"

# floating shell (toggle with prefix + f)
bind-key -T prefix f display-popup -w 80% -h 80% -d "#{pane_current_path}" -E

# toggle syncmode
bind-key a setw synchronize-panes \; display "synchronize-panes #{?pane_synchronized,on,off}"
# ==== status line ====
set-option -g status-position top
# status line を更新する間隔を 1 秒にする
set-option -g status-interval 1

# window-status を中央揃えで配置する
set-option -g status-justify "centre"

# status line の背景色を透過にする
set-option -g status-bg default
set-option -g status-fg "colour250"
set-option -g status-style bg=default

# status-left: セッション名をラインで囲む
set-option -g status-left-length 25
set-option -g status-left "#[fg=colour75,bold]#S #[fg=colour240]─── "

# status-right: ラインで区切る
set-option -g status-right-length 60
set-option -g status-right "#[fg=colour240] ───#[default] #[fg=colour250]#h #[fg=colour240]│#[default] #[fg=colour245]%m/%d %H:%M#[default]"

# window-status のフォーマット（非アクティブ）
set-window-option -g window-status-format "#[fg=colour240]│ #[fg=colour245]#I:#W #[fg=colour240]│"

# カレントウィンドウ: ▎インジケータ + アクセントカラー
set-window-option -g window-status-current-format "#[fg=colour75]▎#[fg=colour75,bold]#I:#W#[default] "

# pane border: 背景色なし
set-option -g pane-border-status bottom
set-option -g pane-border-format "#[fg=colour245] #P #[fg=colour240]│#[default] #($HOME/dotfiles/bin/tmux-pane-border #{pane_current_command} #{pane_pid} #{pane_current_path})"

# ------------------------------ status color -------------------------------
set -g message-style fg=colour75,bg=default
set -g message-command-style fg=colour75,bg=default
# コピーモードのときに、右上に出てくる表示の色
set -g mode-style fg=colour16,bg=colour75

# setw -g window-status-current-format で指定した文字列の色
setw -g window-status-current-style fg=colour75,bold,bg=default
# setw -g window-status-format で指定した文字列の色
setw -g window-status-style fg=colour245,bg=default

# paneを区切っている線の色（背景色なし）
set -g pane-active-border-style fg=colour75,bg=default
set -g pane-border-style fg=colour240,bg=default
# --------------------------------- Operations ------------------------------
# ==== Session ====
bind p switch-client -p
bind n switch-client -n

bind P command-prompt "attach-session -t . -c '#{pane_current_path}'"
# ==== Window ====

# split pain
bind C-k split-window -h
bind C-j split-window -v

# make new window
bind C-c new-window

# change active window
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+


# ==== Pane ====

# begin index of pane from 1
setw -g pane-base-index 1

# move between the panes in the key bindings for vim
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# C-w h/j/k/l でペイン移動（nvim内ならnvimにパススルー）
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-w switch-client -T cw_table
bind -T cw_table h if-shell "$is_vim" "send-keys C-w h" "select-pane -L"
bind -T cw_table j if-shell "$is_vim" "send-keys C-w j" "select-pane -D"
bind -T cw_table k if-shell "$is_vim" "send-keys C-w k" "select-pane -U"
bind -T cw_table l if-shell "$is_vim" "send-keys C-w l" "select-pane -R"

# resize the pane in the key bindings for vim
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2


# ==== Break or kill pane ====

bind b break-pane
bind q kill-pane
bind C-q kill-session
#bind-key C-k display-panes\; kill-pane\;
#bind-key C-k display-panes\; confirm-before kill-pane\;
bind C-x run "tmux kill-pane || tmux kill-window"
bind C-t run "tmux last-pane || tmux last-window || tmux new-window"


#======== ghux ===========
# ghux (floating popup)
bind-key -T prefix g display-popup -w 80% -h 80% -E "zsh -ic ghux"

# --------------------------------- Copy mode ------------------------------
# macOS固有の設定 - Linux環境では無効化
# set-option -g default-command "reattach-to-user-namespace -l zsh"
bind-key -T copy-mode-vi v send-keys -X begin-selection
# bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"
# bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"


# ---------------------------------------------------------------------------
# set-option -g default-terminal screen-256color
# set -g terminal-overrides 'xterm:colors=256'


set -g default-terminal "xterm-256color"
# set -ga terminal-overrides ",xterm-256color:Tc"
#===================================
# Auto start tmux and restore
#===================================

# auto start terminal
# set -g @continuum-boot 'on'
# set -g @continuum-boot-options 'iterm'  # macOS固有 - 無効化

# auto restore tmux
set -g @continuum-restore 'on'

# ------------------------- Plugin ------------------------------------------

# TPM の存在確認と条件分岐
# プラグイン設定（TPMが存在する場合のみ）
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'Morantron/tmux-fingers'

# プラグイン設定
set -g @resurrect-strategy-vim 'session'
set -g @continuum-restore 'on'              # tmux スタート時に自動で復元
set -g @continuum-save-interval '1'         # セッションを保存する間隔を 1 分にする

# tmux-fzf設定
TMUX_FZF_LAUNCH_KEY="F"
set -g @tmux-fzf-launch-key "$TMUX_FZF_LAUNCH_KEY"

# tmux-fingers設定
set -g @fingers-key u
set -g @fingers-jump-key j
set -g @fingers-copy-command 'xclip -selection clipboard'
set -g @fingers-compact-hints 0
set -g @fingers-hint-position 'left'

# TPM の実行（存在する場合のみ）
if-shell "test -d ~/.tmux/plugins/tpm" \
    "run-shell '~/.tmux/plugins/tpm/tpm'"

